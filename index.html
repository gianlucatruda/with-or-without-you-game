<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>With or without you</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body,
        html {
            height: 90%;
            margin: 10px auto;
            display: flex;
            < !-- justify-content: center;
            -->< !-- align-items: center;
            -->< !-- background: #c3c3c3;
            -->
        }

        canvas {
            transform-origin: top center;
            transform: scale(var(--scale-factor, 1));
            /* Scale factor is a custom property */
        }
    </style>
</head>

<body>
    <script>
        let scaleFactor;
        let hedgehog, balloon;
        let score = 0;
        let NEWROUND = true;

        function preload() {
            hedgehogImg = loadImage('hedgehog.png');  // Load the image
        }


        function setup() {
            createCanvas(500, 500);
            let sketchCanvas = document.querySelector('canvas');
            adjustScale(sketchCanvas); // Adjust scale based on the current window size
            window.addEventListener('resize', () => adjustScale(sketchCanvas)); // Adjust scale when window is resized
            rect(0, 0, width, 20); // TODO draw the ground
            hedgehog = new Hedgehog();
            balloon = new Balloon();
            NEWROUND = true;
        }
        function adjustScale(canvas) {
            scaleFactor = Math.min(window.innerWidth / 500, window.innerHeight / 500);
            console.log(scaleFactor);
            document.body.style.setProperty('--scale-factor', scaleFactor);
        }

        function draw() {
            background(220);
            drawGround();
            hedgehog.update();
            hedgehog.show();

            balloon.update();
            balloon.show();

            showScore();

            checkCollision();
        }
        function drawGround() {
            strokeWeight(1);
            fill(100, 60, 20); // Brown color for the ground
            rect(0, height - 20, width, 20); // Draw the rectangle
        }

        function showScore() {
            fill(50, 0, 0);
            textSize(24);  // Size of the text
            text(`Score: ${score}`, 20, 30);  // Displaying the score at the top-left corner
            textSize(12);
            text('Controls: WAD / positional click or tap', 20, 50);
        }

        function checkCollision() {
            // Simple distance check for collision
            if (dist(hedgehog.x, hedgehog.y, balloon.x, balloon.y) < (balloon.width + hedgehog.width) / 2 - 3) {
                noLoop(); // Stop the drawing loop
                alert(`Game Over: Balloon Burst! Score ${score}`);
                location.reload();
            }

            // Check if inside the hoop
            if (dist(hedgehog.x, hedgehog.y, balloon.hoopX, balloon.hoopY) < balloon.hoopSize / 2) {
                if (NEWROUND) {
                    score++;
                    NEWROUND = false;
                }
            }
        }

        function keyPressed() {
            if (key === ' ' || key === 'w') {
                hedgehog.jump();
            }
            if (key === 'd') {
                hedgehog.right();
            }
            if (key === 'a') {
                hedgehog.left();
            }

        }

        function touchStarted() {
            if (touches.length > 0) {  // Check if at least one touch is registered
                // console.log(touches);
                let touchX = touches[0].x;  // Get the x-coordinate of the first touch
                if (touchX / scaleFactor < hedgehog.x) {
                    hedgehog.left();  // Move left if touch is on the left half
                } else {
                    hedgehog.right();  // Move right if touch is on the right half
                }
            }
            hedgehog.jump();  // Also make the hedgehog jump with any touch
            return false; // Prevents default behavior such as scrolling
        }

        class Hedgehog {
            constructor() {
                this.x = 100;
                this.y = height - 30;
                this.vy = 0;
                this.vx = 0;
                this.gravity = 1;
                this.friction = 1.1;
                this.width = 50;
            }

            jump() {
                this.vy = -15;
            }
            right() {
                this.vx += 10;
            }
            left() {
                this.vx -= 10;
            }

            update() {
                this.y += this.vy;
                this.x += this.vx;
                this.vy += this.gravity;
                this.vx = this.vx / this.friction;
                this.y = constrain(this.y, 0, height - 30);
            }

            show() {
                // fill(200, 100, 110);
                // ellipse(this.x, this.y, this.width, this.width);
                image(hedgehogImg, this.x - this.width / 2, this.y - this.width / 2, this.width, this.width);
            }
        }

        class Balloon {
            constructor() {
                this.x = width;
                this.y = 40;
                this.hoopSize = 100;
                this.stringLen = 100;
                this.width = 50;
                this.height = 55;
                this.speed = 1;
                this.helium = 0.1;
            }

            update() {
                this.x -= this.speed;
                this.y -= (this.helium) * this.speed;
                this.speed = score + 1;
                if (this.x < 0) {
                    this.x = width;
                    this.hoopSize = random(40, 100 - score);
                    this.stringLen = random(10, 150 - score);
                    this.y = random(this.height / 2, 150);
                    NEWROUND = true;
                }
                this.hoopY = this.y + this.height / 2 + this.stringLen + this.hoopSize / 2;
                this.hoopX = this.x;
            }

            show() {
                // balloon
                fill(0, 0, 200);
                strokeWeight(1);
                ellipse(this.x, this.y, this.width, this.height);

                // string
                // stroke(0);
                strokeWeight(1);
                line(this.x, this.y + this.height / 2, this.x + 10, this.y + this.height / 2 + this.stringLen); // Adjust these values to position the string correctly

                // hoop
                {
                    noFill();
                    stroke(0, 0, 0);
                    if (!NEWROUND) {
                        stroke(0, 200, 0);
                    }
                    strokeWeight(4);
                    ellipse(this.x + 15, this.hoopY, this.hoopSize, this.hoopSize); // Adjust vertical position to connect with string
                    stroke(0, 0, 0);
                    strokeWeight(1);
                }

                // hitbox
                // fill(50, 0, 0);
                // ellipse(this.hoopX, this.hoopY, this.hoopSize / 1.75, this.hoopSize / 1.75);

            }
        }
    </script>
</body>

</html>
